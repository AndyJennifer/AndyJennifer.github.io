---
title: Jvm系列之运行时数据区域(一)
tags:
- Jvm相关
categories:
- Jvm
---

### 前言

了解 JVM(Java Virtual Machine) 运行时数据区域的划分，是我们解决内存泄露，内存溢出等问题的必要条件，也是应付大多数面试的必要手段。该篇文章主要对涉及到的知识点进行概括。方便大家迅速回顾和归纳总结相关知识点。需要深度了解的小伙伴，推荐阅读《深入理解Java虚拟机》与《Java虚拟机规范 Java SE 8版》。

### 运行时数据区域

Java虚拟机定义了若干种程序运行期间会使用到的运行时数据区，其中有一些会随着虚拟机启动而创建，随着虚拟机退出而销毁。另外一些则是与线程一一对应的。这些与线程对应的数据区域会随着线程开始和结束而创建和销毁。在 JVM 中定义了以下`六`种数据结构的划分：

- 程序计数器、pc寄存器（program counter)
- Java虚拟机栈
- 本地方法栈
- Java堆
- 方法区
- 运行时常量池

具体如下图所示：

{% asset_img 运行时数据区.png 运行时数据区 %}

![运行时数据区](/public/2019/08/18/Jvm系列之运行时数据区域(一)/运行时数据区.png)

### 程序计数器、pc寄存器（pc program register)

- 定义：当前线程所执行的字节码的行号指示器
- 作用：存储当前线程需要执行的字节码指令，控制程序的分支、循环、跳转、异常处理、线程恢复等基础功能。
- 特点：**线程私有的内存区域**，每个线程都拥有独立的程序计数器（因为多线程操作，是通过CPU切换时间片处理的，需要保证线程在恢复的时候，能恢复到正确的指令行数）
- 抛出异常：`不会`抛出任何 oom（OutOfMemoryError)的异常

### Java虚拟机栈

- 定义：Java虚拟机栈存用于存储**栈帧**，虚拟机中为每个方法执行时创建的栈帧（包括局部变量表，操作数，动态链接，方法出口等信息）
- 特点：**线程私有的内存区域**，声明周期与线程相同。
- 抛出异常：
    1. oom（OutOfMemoryError) ：如果虚拟机栈可以动态扩展，那么在无法扩展时无法申请到足够的内存，就会抛出oom。
    2. StackOverflowError：线程请求的栈容量大于虚拟机允许的最大容量，则会抛出该异常。

#### 栈帧

- 定义：用来存储数据和部分过程结果的数据结构，同时也用来处理动态链接,方法返回值和异常分派。
- 生命周期：栈帧随着方法调用而创建，随着方法结束而销毁，无论方法是正常完成还是异常完成（抛出了在方法内未被捕获的异常）都算作方法结束。
- 包括内容；本地变量表，操作数栈，和指向当前方法所属类的运行时常量池的引用。

##### 局部变量表

- 定义：每个栈帧内部都包含一组称为局部变量的变量列表。
- 作用：用于存储`编译期可知`的各种基本数据类型（boolean、byte、char、short、int、float)及对象引用类型和returnAddress类型。
- 访问方式：局部变量使用索引来进行定位访问，首个局部变量的索引值为0，局部变量的索引值是个整数，它大于等于0，且小于局部变量的长度。
- 特点：局部变量所需要的内存在编译期间就完成分配，在方法运行期间不会改变局部变量表的大小。

##### 操作数栈

- 定义：每个栈帧内部都包含一个称为**操作数栈**的后进先出（Last-In-First-Out,LIFO)栈。
- 存储内容：用于存储局部变量表中的变量值，或者对象实例的字段值或常量值。或在调用方法时，用于存储调用方法的参数以及接受方法的返回结果。
- 作用：通过操作数栈上的数据，完成方法的运算与执行。

### 本地方法栈

- 定义：Java虚拟机实现可能会使用到传统的栈（通常为C stack)来支持native方法（指使用Java以外的其他语言编写的方法）的执行，这个栈就是本地方法栈（native method stack)。
- 特点：**线程私有的内存区域**，声明周期与线程相同。
- 抛出异常：
    1. oom（OutOfMemoryError) ：如果本地方法栈可以动态扩展，那么在无法扩展时无法申请到足够的内存，则会抛出该异常
    2. StackOverflowError：线程请求的栈容量大于本地方法栈的最大容量，则会抛出该异常。

### Java堆

- 定义：Java对虚拟机中用于存储所有的对象的实例以及数组的内存区域。是垃圾收集器管理的主要区域。也被称为GC堆。
- 特点： 从内存回收的角度看分为新生代和老年代。 从内存分配的角度看为多个**线程共有的内存缓存区**。
- 抛出异常：oom(OutOfMemoryError)异常，Java堆内存可以固定大小，也可以可扩展的(Java堆在HotSpot中的实现是可扩展的，通过参数-Xmx/-Xms来控制)，如果堆内存没有完成实例分配，并且堆也无法扩展时，则抛出该异常。

#### 方法区

- 定义：堆的一个逻辑部分，为了与Java堆区分开，也叫非堆。方法区有一个别名叫永久代(Permaent Generation)。
- 存储内容：用于存储已经被虚拟机内部加载的每一个类信息（运行时常量池)，类和接口初始化时需要用到的特殊方法，即时编译器编译后的代码等。
- 创建时机：虚拟机启动的时候就会创建
- 抛出异常：oom(OutOfMemoryError)异常，方法区内存可以固定大小，也可以可扩展的(通过-XX:MaxPermSize配置)。如果堆内存没有完成实例分配，并且堆也无法扩展时，则抛出该异常。

##### 运行时常量池

- 定义：运行时常量池是方法区的一部分，是class文件中每一个类或接口的常量池表（Constant pool)的运行时表示形式，主要存储编译期生成字面量（如文本字符串，声明为final的常量值）和符号引用，一般情况下，也会保存Class文件中描述的符号引用外，还会把翻译出来的直接引用也存储在运行时常量池中。

- 符号引用
    1. 类和接口的全限定名
    2. 字段的名称和描述符
    3. 方法的名称和描述符

- 抛出异常：oom(OutOfMemoryError)异常，当创建类或接口时，如果构造运行常量池所需要的内存空间超过了方法区所能提供的最大值，那么将会抛出该异常。

### 最后

该篇文章适合已经理解Jvm运行时区域的小伙伴，通过该文章可以快速的回顾与复习相关知识点，对该知识点不是很理解的小伙伴们，可以参看该文章帮助理解。
