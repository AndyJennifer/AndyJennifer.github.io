---
title: Jvm系列之Java内存结构
tags:
- Jvm
categories:
- Jvm
---

### 运行时数据区域
- 程序计数器
- Java虚拟机栈
- 本地方法栈
- java堆
- 方法区
- 运行时常量池


### 程序计数器（pc program register)
 - 定义：当前线程所执行的字节码的行号指示器
 - 作用：实现从异常处理，线程恢复等基础功能
 - 所在位置：线程私有的内存区域：每个线程都拥有独立的程序计数器（因为多线程操作，是通过CPU切换时间片处理的，需要保证，线程在恢复的时候，能恢复到正确的指令行数）
 - 抛出异常：不会抛出oom（OutOfMemoryError)的异常
 
###  Java虚拟机栈
- 定义：栈内存用于存储，虚拟机中为每个方法执行时创建的栈帧（包括局部变量表，操作数，动态链接，方法出口等信息）
- 特点：声明周期与线程相同，也是线程私有的
- 抛出异常：
1. oom ：如果虚拟机栈可以动态扩展，那么在无法扩展时无法申请到足够的内存，就会抛出oom
2. StackOverflowError：线程请求的栈深度大于虚拟机允许的深度，则会抛出该异常

### 栈帧
- 定义：用来存储数据和部分过程结果的数据结构，同时也用来处理动态链接,方法返回值和异常分派
- 生命周期：栈帧随着方法调用而创建，随着方法结束而销毁，无论方法是正常完成还是异常完成都算作方法结束。
- 包括内容；本地变量表，操作数栈，和指向当前方法所属类的运行时常量池的引用。

#### 局部变量表
- 存储内存：局部变量表中存储了`编译期可知`的各种基本数据类型，对象引用类型。和returnAddress类型。
- 特点，局部变量所需要的内存在编译期间就完成分配，在方法运行期间不会改变局部变量表的大小

#### 操作数栈
- 存储内容：局部变量表中的变量值，或者对象实例的字段值或常量值
- 作用：通过操作数栈上的数据，完成方法的运算与执行

### 本地方法栈
- 定义：基本与虚拟机栈所发挥的作用是相似的，确保就是本地方法栈是为虚拟机使用到的Native方法服务。
- 抛出异常：同Java虚拟机栈基本相同。

### Java堆
- 定义：Java对虚拟机中用于存储所有的对象的实例以及数组的内存区域。是垃圾收集器管理的主要区域。也被称为GC堆
- 从内存回收的角度看：分为新生代和老年代。
- 从内存分配的角度看：多个线程共有的内存缓存区
- 抛出异常：oom 堆内存可以固定大小，也可以可扩展的，如果堆内存没有完成实例分配，并且堆也无法扩展时，则抛出该异常。

### 方法区
- 定义：堆的一个逻辑部分，为了与Java堆区分开，也叫非堆
- 存储内容：虚拟机内部加载的每一个类信息（运行时常量池)，类和接口初始化时需要用到的特殊方法
- 创建时机：虚拟机启动的时候就会创建
- 抛出异常：oom 方法区内存可以固定大小，也可以可扩展的，如果堆内存没有完成实例分配，并且堆也无法扩展时，则抛出该异常。

#### 运行时常量池
- 定义：运行时常量池是方法区的一部分，是class文件中每一个类或接口的常量池表，主要存储字面量（如文本字符串，声明为final的常量值）和符号引用，一般情况下，也会保存Class文件中描述的符号引用外，还会把翻译出来的直接引用也存储在运行时常量池中。
- 符号引用
    1. 类和接口的全限定名
    2. 字段的名称和描述符
    3. 方法的名称和描述符
    
- 抛出异常：oom 当创建类或接口时，如果构造运行常量池所需要的内存空间超过了方法区所能提供的最大值，那么将会抛出oom异常