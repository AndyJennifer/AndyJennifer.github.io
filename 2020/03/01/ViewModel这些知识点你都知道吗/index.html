<!DOCTYPE html>












  


<html class="theme-next mist use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">


























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/bangbangtang-32*32.png?v=7.0.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/bangbangtang-16*16.png?v=7.0.0">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '7.0.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false,"dimmer":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="å‰è¨€ViewModel ä½œä¸º Jetpack ä¸­çš„æ˜æ˜Ÿç»„ä»¶ï¼Œç›¸ä¿¡å¤§å®¶éƒ½å¯¹å…¶æœ‰ä¸€å®šçš„äº†è§£ã€‚åœ¨ Google çš„å®˜æ–¹ä»‹ç»ä¸­ä¹Ÿè¯¦ç»†çš„ç½—åˆ—äº† ViewModel çš„ä¼˜ç‚¹ï¼Œå¦‚ï¼š  å¯ä»¥æä¾›å’Œç®¡ç†UIç•Œé¢æ•°æ®ã€‚(å°†åŠ è½½æ•°æ®ä¸æ•°æ®æ¢å¤ä» Activity or Fragmentä¸­è§£è€¦) å¯æ„ŸçŸ¥ç”Ÿå‘½å‘¨æœŸçš„ç»„ä»¶ã€‚ ä¸ä¼šå› é…ç½®æ”¹å˜è€Œé”€æ¯ã€‚ å¯ä»¥é…åˆ LiveData ä½¿ç”¨ã€‚ å¤šä¸ª Fragment å¯ä»¥å…±äº«åŒä¸€ V">
<meta name="keywords" content="ViewModel">
<meta property="og:type" content="article">
<meta property="og:title" content="ViewModelè¿™äº›çŸ¥è¯†ç‚¹ä½ éƒ½çŸ¥é“å—">
<meta property="og:url" content="http://yoursite.com/2020/03/01/ViewModelè¿™äº›çŸ¥è¯†ç‚¹ä½ éƒ½çŸ¥é“å—/index.html">
<meta property="og:site_name" content="AndyJennifer&#39;Blog">
<meta property="og:description" content="å‰è¨€ViewModel ä½œä¸º Jetpack ä¸­çš„æ˜æ˜Ÿç»„ä»¶ï¼Œç›¸ä¿¡å¤§å®¶éƒ½å¯¹å…¶æœ‰ä¸€å®šçš„äº†è§£ã€‚åœ¨ Google çš„å®˜æ–¹ä»‹ç»ä¸­ä¹Ÿè¯¦ç»†çš„ç½—åˆ—äº† ViewModel çš„ä¼˜ç‚¹ï¼Œå¦‚ï¼š  å¯ä»¥æä¾›å’Œç®¡ç†UIç•Œé¢æ•°æ®ã€‚(å°†åŠ è½½æ•°æ®ä¸æ•°æ®æ¢å¤ä» Activity or Fragmentä¸­è§£è€¦) å¯æ„ŸçŸ¥ç”Ÿå‘½å‘¨æœŸçš„ç»„ä»¶ã€‚ ä¸ä¼šå› é…ç½®æ”¹å˜è€Œé”€æ¯ã€‚ å¯ä»¥é…åˆ LiveData ä½¿ç”¨ã€‚ å¤šä¸ª Fragment å¯ä»¥å…±äº«åŒä¸€ V">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://yoursite.com/2020/03/01/ViewModelè¿™äº›çŸ¥è¯†ç‚¹ä½ éƒ½çŸ¥é“å—/æˆéƒ½.JPG">
<meta property="og:image" content="http://yoursite.com/2020/03/01/ViewModelè¿™äº›çŸ¥è¯†ç‚¹ä½ éƒ½çŸ¥é“å—/Activityä¸‹ViewModelçš„åˆ›å»ºè¿‡ç¨‹.png">
<meta property="og:image" content="http://yoursite.com/2020/03/01/ViewModelè¿™äº›çŸ¥è¯†ç‚¹ä½ éƒ½çŸ¥é“å—/viewmodel-lifecycle.png">
<meta property="og:image" content="http://yoursite.com/2020/03/01/ViewModelè¿™äº›çŸ¥è¯†ç‚¹ä½ éƒ½çŸ¥é“å—/æ•°æ®æ¢å¤å¯¹æ¯”.png">
<meta property="og:image" content="http://yoursite.com/2020/03/01/ViewModelè¿™äº›çŸ¥è¯†ç‚¹ä½ éƒ½çŸ¥é“å—/FragmentManageræ ˆå¯¹åº”å…³ç³».png">
<meta property="og:image" content="http://yoursite.com/2020/03/01/ViewModelè¿™äº›çŸ¥è¯†ç‚¹ä½ éƒ½çŸ¥é“å—/FragmentManagerViewModel.png">
<meta property="og:image" content="http://yoursite.com/2020/03/01/ViewModelè¿™äº›çŸ¥è¯†ç‚¹ä½ éƒ½çŸ¥é“å—/ç¬¬ä¸€æ­¥æµç¨‹.png">
<meta property="og:image" content="http://yoursite.com/2020/03/01/ViewModelè¿™äº›çŸ¥è¯†ç‚¹ä½ éƒ½çŸ¥é“å—/ç¬¬äºŒæ­¥æµç¨‹.png">
<meta property="og:image" content="http://yoursite.com/2020/03/01/ViewModelè¿™äº›çŸ¥è¯†ç‚¹ä½ éƒ½çŸ¥é“å—/ç¬¬ä¸‰æ­¥æµç¨‹.png">
<meta property="og:image" content="http://yoursite.com/2020/03/01/ViewModelè¿™äº›çŸ¥è¯†ç‚¹ä½ éƒ½çŸ¥é“å—/Activityä¸FragmentåµŒå¥—.png">
<meta property="og:image" content="http://yoursite.com/2020/03/01/ViewModelè¿™äº›çŸ¥è¯†ç‚¹ä½ éƒ½çŸ¥é“å—/åµŒå¥—ä¸‹å®é™…ç»“æ„.jpg">
<meta property="og:updated_time" content="2020-03-01T15:15:49.426Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ViewModelè¿™äº›çŸ¥è¯†ç‚¹ä½ éƒ½çŸ¥é“å—">
<meta name="twitter:description" content="å‰è¨€ViewModel ä½œä¸º Jetpack ä¸­çš„æ˜æ˜Ÿç»„ä»¶ï¼Œç›¸ä¿¡å¤§å®¶éƒ½å¯¹å…¶æœ‰ä¸€å®šçš„äº†è§£ã€‚åœ¨ Google çš„å®˜æ–¹ä»‹ç»ä¸­ä¹Ÿè¯¦ç»†çš„ç½—åˆ—äº† ViewModel çš„ä¼˜ç‚¹ï¼Œå¦‚ï¼š  å¯ä»¥æä¾›å’Œç®¡ç†UIç•Œé¢æ•°æ®ã€‚(å°†åŠ è½½æ•°æ®ä¸æ•°æ®æ¢å¤ä» Activity or Fragmentä¸­è§£è€¦) å¯æ„ŸçŸ¥ç”Ÿå‘½å‘¨æœŸçš„ç»„ä»¶ã€‚ ä¸ä¼šå› é…ç½®æ”¹å˜è€Œé”€æ¯ã€‚ å¯ä»¥é…åˆ LiveData ä½¿ç”¨ã€‚ å¤šä¸ª Fragment å¯ä»¥å…±äº«åŒä¸€ V">
<meta name="twitter:image" content="http://yoursite.com/2020/03/01/ViewModelè¿™äº›çŸ¥è¯†ç‚¹ä½ éƒ½çŸ¥é“å—/æˆéƒ½.JPG">






  <link rel="canonical" href="http://yoursite.com/2020/03/01/ViewModelè¿™äº›çŸ¥è¯†ç‚¹ä½ éƒ½çŸ¥é“å—/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>ViewModelè¿™äº›çŸ¥è¯†ç‚¹ä½ éƒ½çŸ¥é“å— | AndyJennifer'Blog</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">AndyJennifer'Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">What would life be if we had no courage to attempt anything?</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>é¦–é¡µ</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>å…³äº</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>æ ‡ç­¾</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>åˆ†ç±»</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>å½’æ¡£</a>

  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    
  
  
  
  

  

  <a href="https://github.com/AndyJennifer" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewbox="0 0 250 250" style="fill: #222; color: #fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a>



    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/01/ViewModelè¿™äº›çŸ¥è¯†ç‚¹ä½ éƒ½çŸ¥é“å—/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="AndyJennifer">
      <meta itemprop="description" content="AndyJennifer ä¸ªäººç«™ï¼Œä¸»è¦æ¶‰åŠAndroidã€Javaã€Kotlinç­‰ç›¸å…³çŸ¥è¯†ï¼Œæ„¿ä¸å¤§å®¶å…±åŒå­¦ä¹ ï¼Œå…±åŒè¿›æ­¥">
      <meta itemprop="image" content="http://upload-images.jianshu.io/upload_images/2824145-e320240ea6ec767d.JPG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="AndyJennifer'Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">ViewModelè¿™äº›çŸ¥è¯†ç‚¹ä½ éƒ½çŸ¥é“å—

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              
                
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2020-03-01 23:15:49" itemprop="dateCreated datePublished" datetime="2020-03-01T23:15:49+08:00">2020-03-01</time>
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Jetpack/" itemprop="url" rel="index"><span itemprop="name">Jetpack</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="post-meta-item-icon">
            <i class="fa fa-eye"></i>
             é˜…è¯»æ¬¡æ•°ï¼š 
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
            </span>

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
                
                <span title="æœ¬æ–‡å­—æ•°">24k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
                
                <span title="é˜…è¯»æ—¶é•¿">43 åˆ†é’Ÿ</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <img src="/2020/03/01/ViewModelè¿™äº›çŸ¥è¯†ç‚¹ä½ éƒ½çŸ¥é“å—/æˆéƒ½.JPG" title="æˆéƒ½">
<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p><a href="https://developer.android.google.cn/topic/libraries/architecture/viewmodel" target="_blank" rel="noopener">ViewModel</a> ä½œä¸º <a href="https://developer.android.google.cn/jetpack" target="_blank" rel="noopener">Jetpack</a> ä¸­çš„æ˜æ˜Ÿç»„ä»¶ï¼Œç›¸ä¿¡å¤§å®¶éƒ½å¯¹å…¶æœ‰ä¸€å®šçš„äº†è§£ã€‚åœ¨ Google çš„å®˜æ–¹ä»‹ç»ä¸­ä¹Ÿè¯¦ç»†çš„ç½—åˆ—äº† ViewModel çš„ä¼˜ç‚¹ï¼Œå¦‚ï¼š</p>
<ol>
<li>å¯ä»¥æä¾›å’Œç®¡ç†UIç•Œé¢æ•°æ®ã€‚(å°†åŠ è½½æ•°æ®ä¸æ•°æ®æ¢å¤ä» Activity or Fragmentä¸­è§£è€¦)</li>
<li>å¯æ„ŸçŸ¥ç”Ÿå‘½å‘¨æœŸçš„ç»„ä»¶ã€‚</li>
<li>ä¸ä¼šå› é…ç½®æ”¹å˜è€Œé”€æ¯ã€‚</li>
<li>å¯ä»¥é…åˆ LiveData ä½¿ç”¨ã€‚</li>
<li>å¤šä¸ª Fragment å¯ä»¥å…±äº«åŒä¸€ ViewModelã€‚</li>
<li>ç­‰ç­‰ç­‰â€¦.</li>
</ol>
<p>ä½ ä¹Ÿå¯ä»¥é€šè¿‡ä¸‹åˆ—ä¸¤ä¸ªè§†é¢‘ï¼Œæ›´ä¸ºè¯¦ç»†çš„äº†è§£ ViewModelï¼š</p>
<ul>
<li><a href="https://v.qq.com/x/page/t0763s9ma8o.html" target="_blank" rel="noopener">ViewModeç”·ç”Ÿè®²è§£ç‰ˆ</a></li>
<li><a href="https://v.qq.com/x/page/m0605c1sejh.html" target="_blank" rel="noopener">ViewModeå¥³ç”Ÿè®²è§£ç‰ˆ</a></li>
</ul>
<p>åœ¨æœ¬ç¯‡æ–‡ç« ä¸­ï¼Œä¸ä¼šè®²è§£ ViewModel çš„ä½¿ç”¨æ–¹å¼åŠä½¿ç”¨ ViewModel çš„åŸå› ï¼Œè€Œæ˜¯ç€é‡äºè®²è§£ ViewModel çš„åŸç†ã€‚é€šè¿‡é˜…è¯»æœ¬ç¯‡æ–‡ç« ä½ èƒ½äº†è§£åˆ°ï¼š</p>
<ul>
<li>ViewModel åœ¨ Activity ä¸­çš„ç»‘å®šè¿‡ç¨‹ã€‚</li>
<li>ViewModel åœ¨ Activity ä¸­ä¸ä¼šå› é…ç½®æ”¹å˜è€Œé”€æ¯çš„åŸç†ã€‚</li>
<li>ViewModel åœ¨ Fragment ä¸­çš„ç»‘å®šè¿‡ç¨‹ã€‚</li>
<li>ViewModel åœ¨ Fragment ä¸­ä¸ä¼šå› é…ç½®æ”¹å˜è€Œé”€æ¯çš„åŸç†ã€‚</li>
<li>ViewMode èƒ½åœ¨ Fragment ä¸­å…±äº«çš„åŸç†ã€‚</li>
</ul>
<p>å¸Œæœ›é€šè¿‡è¯¥ç¯‡æ–‡ç« ï¼Œå¤§å®¶èƒ½å¯¹ ViewModel æœ‰æ›´æ·±å…¥çš„äº†è§£ã€‚</p>
<h2 id="ViewModel-ä¸-Activity-çš„ç»‘å®šè¿‡ç¨‹"><a href="#ViewModel-ä¸-Activity-çš„ç»‘å®šè¿‡ç¨‹" class="headerlink" title="ViewModel ä¸ Activity çš„ç»‘å®šè¿‡ç¨‹"></a>ViewModel ä¸ Activity çš„ç»‘å®šè¿‡ç¨‹</h2><p>ä¸€èˆ¬æƒ…å†µä¸‹ä½¿ç”¨ <code>ViewModel</code>ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šå…ˆå£°æ˜è‡ªå·±çš„ ViewModelï¼Œå¹¶åœ¨ Activity ä¸­çš„ <code>onCreate</code> æ–¹æ³•ä¸­ä½¿ç”¨ <code>ViewModelProviders</code> æ¥åˆ›å»º ViewModelã€‚ å¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MyViewModel model = ViewModelProviders.of(<span class="keyword">this</span>).get(MyViewModel.class);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>åœ¨è°·æ­Œçš„æœ€æ–°ä»£ç ä¸­ï¼Œä¸æ¨èä½¿ç”¨ <code>ViweModelProviders(æ³¨æ„æ˜¯æœ‰sçš„å‘¦)</code> ï¼Œè€Œæ˜¯ç›´æ¥ä½¿ç”¨  <code>ViewModelProvider</code> çš„æ„é€ å‡½æ•°æ¥åˆ›å»º <code>ViewModelProvider</code> å¯¹è±¡ã€‚</p>
</blockquote>
<p>é€šè¿‡ä½¿ç”¨ <code>ViewModelProviders</code> ç±»çš„ <code>of()</code> æ–¹æ³•ï¼Œæˆ‘ä»¬ä¼šå¾—åˆ°ä¸€ä¸ª <code>ViewModelProvider</code> å¯¹è±¡ã€‚å¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ViewModelProvider <span class="title">of</span><span class="params">(@NonNull FragmentActivity activity)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">new</span> ViewModelProvider(activity);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>ViewModelProvider ç±»éœ€è¦æˆ‘ä»¬ä¼ é€’ <code>ViewModelStore</code> ä¸ <code>Factory</code> å¯¹è±¡ã€‚å…¶æ„é€ å‡½æ•°å£°æ˜å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä½¿ç”¨ViewModelStoreOwnerå¯¹è±¡æ„é€ å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ViewModelProvider</span><span class="params">(@NonNull ViewModelStoreOwner owner)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(owner.getViewModelStore(), owner <span class="keyword">instanceof</span> HasDefaultViewModelProviderFactory</span><br><span class="line">            ? ((HasDefaultViewModelProviderFactory) owner).getDefaultViewModelProviderFactory()</span><br><span class="line">            : NewInstanceFactory.getInstance());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä½¿ç”¨ViewModelStoreOwnerä¸Factoryå¯¹è±¡çš„æ„é€ å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ViewModelProvider</span><span class="params">(@NonNull ViewModelStoreOwner owner, @NonNull Factory factory)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(owner.getViewModelStore(), factory);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä½¿ç”¨ViewModelStoreä¸Factoryå¯¹è±¡çš„æ„é€ å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ViewModelProvider</span><span class="params">(@NonNull ViewModelStore store, @NonNull Factory factory)</span> </span>&#123;</span><br><span class="line">    mFactory = factory;</span><br><span class="line">    mViewModelStore = store;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ ViewModelProvider å†…éƒ¨ï¼Œæ‹¥æœ‰ä¸‰ç§ç±»å‹æ„é€ å‡½æ•°ï¼š</p>
<ul>
<li><code>(ViewModelStoreOwner owner)</code>:<ul>
<li>è¯¥æ„é€ å‡½æ•°ä½¿ç”¨ owner å¯¹è±¡çš„ <code>getViewModelStore()</code> æ–¹æ³•æ¥è·å– <code>ViewModelStore</code> å¯¹è±¡ï¼Œå¦‚æœä¼ å…¥çš„ owner å¯¹è±¡ä¹Ÿå®ç°äº† <code>HasDefaultViewModelProviderFactory</code> æ¥å£æ—¶ï¼Œé‚£ä¹ˆä¼šè°ƒç”¨ <code>getDefaultViewModelProviderFactory()</code> æ–¹æ³•è·å– Factoryã€‚åä¹‹ï¼Œä½¿ç”¨å†…éƒ¨é™æ€çš„ <code>NewInstanceFactory</code> å¯¹è±¡æ¥åˆ›å»º Factory å¯¹è±¡ã€‚</li>
</ul>
</li>
<li><code>(ViewModelStoreOwner owner,  Factory factory)</code>:<ul>
<li>è¯¥æ„é€ å‡½æ•°ä½¿ç”¨ owner å¯¹è±¡çš„ <code>getViewModelStore()</code> æ–¹æ³•æ¥è·å– <code>ViewModelStore</code> å¯¹è±¡ï¼Œä½¿ç”¨ä¼ é€’çš„ Factory å¯¹è±¡</li>
</ul>
</li>
<li><code>(ViewModelStore store, Factory factory)</code>ï¼š<ul>
<li>ä½¿ç”¨ <code>ViewModelStore</code> ä¸ <code>Factory</code> å¯¹è±¡çš„æ„é€ å‡½æ•°</li>
</ul>
</li>
</ul>
<h3 id="Factory-æ¥å£ä»‹ç»"><a href="#Factory-æ¥å£ä»‹ç»" class="headerlink" title="Factory æ¥å£ä»‹ç»"></a>Factory æ¥å£ä»‹ç»</h3><p>åœ¨ ViewModelProvider ä¸­ï¼Œ<code>Factory</code> ä¸»è¦ç”¨äºåˆ›å»º ViewModelï¼ŒFactory çš„å£°æ˜å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Factory</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é€šè¿‡ç»™å®šçš„Classå¯¹è±¡åˆ›å»ºViewModelå¯¹è±¡</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> modelClass æ‰€éœ€ViewModelçš„Classå¯¹è±¡</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;        ViewModelçš„æ³›å‹å‚æ•°</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> æ–°åˆ›å»ºçš„ViewModelå¯¹è±¡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    &lt;T extends ViewModel&gt; <span class="function">T <span class="title">create</span><span class="params">(@NonNull Class&lt;T&gt; modelClass)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡å®ç° Factory æ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°è‡ªå·±æƒ³è¦çš„å·¥å‚ä»¥åˆ›å»ºæ‰€éœ€çš„ ViewModelã€‚åœ¨ Android ä¸­æœ‰å¤šä¸ªç±»éƒ½å®ç°äº†è¯¥æ¥å£<code>(å¦‚ KeyedFactory, AndroidViewModelFactory)</code>ï¼Œè¿™é‡Œä»¥é»˜è®¤çš„ <code>NewInstanceFactory</code> ä¸ºä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">NewInstanceFactory</span> <span class="keyword">implements</span> <span class="title">Factory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> NewInstanceFactory sInstance;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> NewInstanceFactory <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (sInstance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            sInstance = <span class="keyword">new</span> NewInstanceFactory();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sInstance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"ClassNewInstance"</span>)</span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T extends ViewModel&gt; <span class="function">T <span class="title">create</span><span class="params">(@NonNull Class&lt;T&gt; modelClass)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//é»˜è®¤ä½¿ç”¨å¯¹åº”ViewModelç±»æ— å‚çš„æ„é€ å‡½æ•°åˆ›å»ºå®ä¾‹å¯¹è±¡</span></span><br><span class="line">            <span class="keyword">return</span> modelClass.newInstance();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Cannot create an instance of "</span> + modelClass, e);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Cannot create an instance of "</span> + modelClass, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œ <code>NewInstanceFactory</code> ä¼šè°ƒç”¨ ViewModel çš„<strong>æ— å‚æ„é€ å‡½æ•°</strong>åˆ›å»ºå®ä¾‹å¯¹è±¡ï¼Œå½“ç„¶å¦‚æœä½ éœ€è¦åœ¨ ViewModel ä¸­ä½¿ç”¨å…¶ä»–å‚æ•°ï¼Œä½ ä¹Ÿå¯ä»¥ä¼ é€’è‡ªå®šä¹‰çš„ Factoryã€‚</p>
<h3 id="ViewModelStore-ä»‹ç»"><a href="#ViewModelStore-ä»‹ç»" class="headerlink" title="ViewModelStore ä»‹ç»"></a>ViewModelStore ä»‹ç»</h3><p>ViewModelStore å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ª HashMapï¼Œå…¶ key ä¸º <code>DEFAULT_KEY</code> + <code>ViewModelçš„Classå¯¹è±¡åº•å±‚ç±»è§„èŒƒåç§°</code>ï¼Œå…¶ value ä¸ºå¯¹åº” <code>ViewModel</code> å¯¹è±¡ã€‚æ¯ä¸ª Activity ä¸ Fragment éƒ½å¯¹åº”ç€ä¸€ä¸ª <code>ViewModelStore</code> ï¼Œç”¨äºå­˜å‚¨æ‰€éœ€çš„ ViewModelã€‚ViewModelStore ç±»å£°æ˜å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<blockquote>
<p>DEFAULT_KEY å€¼ä¸ºï¼šâ€androidx.lifecycle.ViewModelProvider.DefaultKeyâ€</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewModelStore</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HashMap&lt;String, ViewModel&gt; mMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(String key, ViewModel viewModel)</span> </span>&#123;</span><br><span class="line">        ViewModel oldViewModel = mMap.put(key, viewModel);</span><br><span class="line">        <span class="keyword">if</span> (oldViewModel != <span class="keyword">null</span>) &#123;</span><br><span class="line">            oldViewModel.onCleared();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">final</span> ViewModel <span class="title">get</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mMap.get(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">Set&lt;String&gt; <span class="title">keys</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> HashSet&lt;&gt;(mMap.keySet());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å½“å†…éƒ¨çš„ ViewModel ä¸å†ä½¿ç”¨æ—¶ï¼Œæ¸…é™¤æ‰€å çš„å†…å­˜</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (ViewModel vm : mMap.values()) &#123;</span><br><span class="line">            <span class="comment">//ä¸‹é¢è°ƒç”¨ViewModelçš„clearæ–¹æ³•</span></span><br><span class="line">            vm.clear();</span><br><span class="line">        &#125;</span><br><span class="line">        mMap.clear();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Activity-ä¸­åˆ›å»ºä¸è·å–-ViewModel-æµç¨‹"><a href="#Activity-ä¸­åˆ›å»ºä¸è·å–-ViewModel-æµç¨‹" class="headerlink" title="Activity ä¸­åˆ›å»ºä¸è·å– ViewModel æµç¨‹"></a>Activity ä¸­åˆ›å»ºä¸è·å– ViewModel æµç¨‹</h3><p>ViewModel æœ€ç»ˆçš„åˆ›å»ºä¸è·å–ï¼Œéœ€è¦ ViewProvider ç±»è°ƒç”¨ <code>get(Class&lt;T&gt; modelClass)</code>æ–¹æ³•ï¼ˆè¯¥æ–¹æ³•å†…éƒ¨é€šè¿‡ ViewModelStore ä¸ Factory çš„é…åˆï¼Œåˆ›å»ºå¹¶ä¿å­˜äº†æ‰€éœ€çš„ ViewModel å¯¹è±¡ï¼‰ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T extends ViewModel&gt; <span class="function">T <span class="title">get</span><span class="params">(@NonNull Class&lt;T&gt; modelClass)</span> </span>&#123;</span><br><span class="line">       String canonicalName = modelClass.getCanonicalName();</span><br><span class="line">       <span class="keyword">if</span> (canonicalName == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Local and anonymous classes can not be ViewModels"</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> get(DEFAULT_KEY + <span class="string">":"</span> + canonicalName, modelClass);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>è¯¥æ–¹æ³•å†…éƒ¨ä¼šè°ƒç”¨ <code>get(String key, Class&lt;T&gt; modelClass)</code> æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T extends ViewModel&gt; <span class="function">T <span class="title">get</span><span class="params">(@NonNull String key, @NonNull Class&lt;T&gt; modelClass)</span> </span>&#123;</span><br><span class="line">       <span class="comment">//ğŸ‘‡æ ¹æ®keyå€¼ä»ViewModelStoreä¸­å–å¯¹åº”çš„ViewModel</span></span><br><span class="line">       ViewModel viewModel = mViewModelStore.get(key);</span><br><span class="line">       <span class="comment">//ğŸ‘‡åˆ¤æ–­æ‰€ä¼ å…¥çš„Classå¯¹è±¡æ˜¯å¦æ˜¯ViewModelçš„Classç±»æˆ–å…¶å­ç±»çš„å¯¹è±¡ï¼Œå¦‚æœæ˜¯ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">       <span class="keyword">if</span> (modelClass.isInstance(viewModel)) &#123;</span><br><span class="line">           <span class="keyword">if</span> (mFactory <span class="keyword">instanceof</span> OnRequeryFactory) &#123;</span><br><span class="line">               ((OnRequeryFactory) mFactory).onRequery(viewModel);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span> (T) viewModel;</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="comment">//noinspection StatementWithEmptyBody</span></span><br><span class="line">           <span class="keyword">if</span> (viewModel != <span class="keyword">null</span>) &#123;</span><br><span class="line">               <span class="comment">// <span class="doctag">TODO:</span> log a warning.</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//ğŸ‘‡å¦‚æœä¸ºnullï¼Œæ ¹æ®ä¼ å…¥çš„Factoryåˆ›å»ºæ–°çš„VideModel</span></span><br><span class="line">       <span class="keyword">if</span> (mFactory <span class="keyword">instanceof</span> KeyedFactory) &#123;</span><br><span class="line">           viewModel = ((KeyedFactory) (mFactory)).create(key, modelClass);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           viewModel = (mFactory).create(modelClass);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//ğŸ‘‡å°†æ–°çš„ ViewModel å­˜å…¥ViewModelStoreï¼Œå¹¶è¿”å›</span></span><br><span class="line">       mViewModelStore.put(key, viewModel);</span><br><span class="line">       <span class="keyword">return</span> (T) viewModel;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨è¯¥æ–¹æ³•ä¸­ï¼Œä¼šåœ¨ ViewModelStore ä¸­æ ¹æ®ä¼ å…¥çš„ key è·å–å¹¶ä¿å­˜ ViewModelã€‚å…¶å…·ä½“é€»è¾‘å¦‚ä¸‹ï¼š</p>
<ul>
<li>æ ¹æ® key å€¼ä» ViewModelStore ä¸­å–å¯¹åº”çš„ ViewModelã€‚</li>
<li>åˆ¤æ–­æ‰€ä¼ å…¥çš„ Class å¯¹è±¡æ˜¯å¦æ˜¯ ViewModel çš„ Class ç±»æˆ–å…¶å­ç±»çš„å¯¹è±¡ï¼Œå¦‚æœæ˜¯ï¼Œç›´æ¥è¿”å›ã€‚(å½“ <code>Object.isInstance(class)</code> æ¥å—çš„å‚æ•°ä¸º <code>null</code> æ—¶ï¼Œè¯¥æ–¹æ³•ä¼šè¿”å›  <code>false</code>ï¼‰</li>
<li><p>å¦‚æœè·å–çš„ ViewModel ä¸º nullï¼Œä¼šæ ¹æ®ä¼ å…¥çš„ Factory å¯¹è±¡åˆ›å»ºæ–°çš„ VideModelï¼Œå¹¶å°†åˆ›å»ºå¥½çš„ ViewModel æ”¾å…¥ ViewModelStoreä¸­ã€‚</p>
<p>Activity ä¸­åˆ›å»ºä¸è·å– ViewModel çš„æ•´ä½“æµç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
</li>
</ul>
<img src="/2020/03/01/ViewModelè¿™äº›çŸ¥è¯†ç‚¹ä½ éƒ½çŸ¥é“å—/Activityä¸‹ViewModelçš„åˆ›å»ºè¿‡ç¨‹.png" title="Activityä¸‹ViewModelçš„åˆ›å»ºè¿‡ç¨‹">
<h2 id="ViewModel-åœ¨-Activity-ä¸­ä¸ä¼šå› é…ç½®æ”¹å˜è€Œé”€æ¯çš„åŸç†"><a href="#ViewModel-åœ¨-Activity-ä¸­ä¸ä¼šå› é…ç½®æ”¹å˜è€Œé”€æ¯çš„åŸç†" class="headerlink" title="ViewModel åœ¨ Activity ä¸­ä¸ä¼šå› é…ç½®æ”¹å˜è€Œé”€æ¯çš„åŸç†"></a>ViewModel åœ¨ Activity ä¸­ä¸ä¼šå› é…ç½®æ”¹å˜è€Œé”€æ¯çš„åŸç†</h2><p>æˆ‘ä»¬éƒ½çŸ¥é“ ViewModel ä¸ä¼šå› ä¸º Activity çš„é…ç½®å‘ç”Ÿæ”¹å˜è€Œé”€æ¯ï¼ŒViewModel ä½œç”¨åŸŸå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<img src="/2020/03/01/ViewModelè¿™äº›çŸ¥è¯†ç‚¹ä½ éƒ½çŸ¥é“å—/viewmodel-lifecycle.png" title="viewmodel-lifecycle">
<p>è§‚å¯Ÿä¸Šå›¾ï¼Œæˆ‘ç›¸ä¿¡å°ä¼™ä¼´ä»¬è‚¯å®šæœ‰å¦‚ä¸‹ç–‘æƒ‘ï¼š</p>
<ul>
<li>å½“ Activity å› é…ç½®å‘ç”Ÿæ”¹å˜æ—¶ï¼Œç³»ç»Ÿä¼šé‡æ–°åˆ›å»ºä¸€ä¸ªæ–°çš„ Activity ã€‚é‚£è€çš„ Activity ä¸­çš„ ViewModel æ˜¯å¦‚ä½•ä¼ é€’ç»™æ–°çš„ Activity çš„å‘¢ï¼Ÿ</li>
<li>ViewModel åˆæ˜¯å¦‚ä½•æ„ŸçŸ¥é…ç½®æ˜¯å¦æ”¹å˜ï¼Œè¿›è€Œåˆ¤æ–­æ˜¯å¦é”€æ¯çš„å‘¢ï¼Ÿ</li>
</ul>
<p>è¦è§£å†³å¦‚ä¸Šé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦äº†è§£ Android ä¸­æ•°æ®æ¢å¤çš„æ–¹å¼ä»¥åŠ Activity ç”Ÿå‘½å‘¨æœŸä¸­ ViewModel å®é™…å¤„ç†æµç¨‹ã€‚</p>
<h3 id="æ•°æ®æ¢å¤çš„å¸¸è§æ–¹å¼"><a href="#æ•°æ®æ¢å¤çš„å¸¸è§æ–¹å¼" class="headerlink" title="æ•°æ®æ¢å¤çš„å¸¸è§æ–¹å¼"></a>æ•°æ®æ¢å¤çš„å¸¸è§æ–¹å¼</h3><p>åœ¨ Android ç³»ç»Ÿä¸­ï¼Œéœ€è¦æ•°æ®æ¢å¤æœ‰å¦‚ä¸‹ä¸¤ç§åœºæ™¯ï¼š</p>
<ul>
<li>åœºæ™¯1ï¼šèµ„æºç›¸å…³çš„é…ç½®å‘ç”Ÿæ”¹å˜å¯¼è‡´ Activity è¢«æ€æ­»å¹¶é‡æ–°åˆ›å»ºã€‚</li>
<li>åœºæ™¯2ï¼šèµ„æºå†…å­˜ä¸è¶³å¯¼è‡´ä½ä¼˜å…ˆçº§çš„ Activity è¢«æ€æ­»ã€‚</li>
</ul>
<p>é’ˆå¯¹ä¸Šè¿°åœºæ™¯ï¼Œåˆ†åˆ«å¯¹åº”ä¸‰ç§ä¸åŒçš„æ•°æ®æ¢å¤æ–¹å¼ã€‚</p>
<blockquote>
<p>å¯¹åº”åœºæ™¯1ï¼Œä¸è€ƒè™‘åœ¨æ¸…å•æ–‡ä»¶ä¸­é…ç½® <code>android:configChanges</code> çš„ç‰¹æ®Šæƒ…å†µã€‚</p>
</blockquote>
<h4 id="ä½¿ç”¨-onSaveInstanceState-ä¸-onRestoreInstanceState"><a href="#ä½¿ç”¨-onSaveInstanceState-ä¸-onRestoreInstanceState" class="headerlink" title="ä½¿ç”¨ onSaveInstanceState ä¸ onRestoreInstanceState"></a>ä½¿ç”¨ onSaveInstanceState ä¸ onRestoreInstanceState</h4><p>ä½¿ç”¨ onSaveInstanceState ä¸ onRestoreInstanceState æ–¹æ³•ï¼Œèƒ½å¤„ç†åœºæ™¯1ä¸åœºæ™¯2çš„æƒ…å†µã€‚å½“ä½ çš„ç•Œé¢æ•°æ®ç®€å•ä¸”è½»é‡æ—¶ï¼Œä¾‹å¦‚åŸå§‹æ•°æ®ç±»å‹æˆ–ç®€å•å¯¹è±¡ï¼ˆæ¯”å¦‚ String)ï¼Œåˆ™æˆ‘ä»¬å¯ä»¥é‡‡ç”¨è¯¥æ–¹å¼ã€‚å¦‚æœä½ éœ€è¦æ¢å¤çš„æ•°æ®è¾ƒä¸ºå¤æ‚ï¼Œé‚£ä½ åº”è¯¥è€ƒè™‘ä½¿ç”¨ <code>ViewModle + onSaveInstanceState()</code> (ä¸ºä»€ä¹ˆè¦é…åˆä½¿ç”¨ï¼Œä¼šåœ¨ä¸‹æ–‡è¿›è¡Œè®²è§£)ï¼Œå› ä¸ºä½¿ç”¨ onSaveInstanceState() ä¼šå¯¼è‡´åºåˆ—åŒ–æˆ–ååºåˆ—åŒ–ï¼Œè€Œè¿™ï¼Œæœ‰ä¸€å®šçš„æ—¶é—´æ¶ˆè€—ã€‚</p>
<p>onSaveInstanceState() æ›´ä¸ºè¯¦ç»†çš„ä»‹ç»ä»¥åŠä½¿ç”¨ï¼Œå¯å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼š</p>
<ul>
<li><a href="https://developer.android.google.cn/guide/components/activities/activity-lifecycle.html#%E4%BD%BF%E7%94%A8-onsaveinstancestate-%E4%BF%9D%E5%AD%98%E7%AE%80%E5%8D%95%E8%BD%BB%E9%87%8F%E7%9A%84%E7%95%8C%E9%9D%A2%E7%8A%B6%E6%80%81" target="_blank" rel="noopener">ä½¿ç”¨ onSaveInstanceState() ä¿å­˜ç®€å•è½»é‡çš„ç•Œé¢çŠ¶æ€</a></li>
<li><a href="https://developer.android.google.cn/guide/components/activities/activity-lifecycle.html#%E4%BD%BF%E7%94%A8%E4%BF%9D%E5%AD%98%E7%9A%84%E5%AE%9E%E4%BE%8B%E7%8A%B6%E6%80%81%E6%81%A2%E5%A4%8D-activity-%E7%95%8C%E9%9D%A2%E7%8A%B6%E6%80%81" target="_blank" rel="noopener">ä½¿ç”¨ä¿å­˜çš„å®ä¾‹çŠ¶æ€æ¢å¤ Activity ç•Œé¢çŠ¶æ€</a></li>
</ul>
<h4 id="ä½¿ç”¨-Fragment-çš„-setRetainInstance"><a href="#ä½¿ç”¨-Fragment-çš„-setRetainInstance" class="headerlink" title="ä½¿ç”¨ Fragment çš„ setRetainInstance"></a>ä½¿ç”¨ Fragment çš„ setRetainInstance</h4><p>å½“é…ç½®å‘ç”Ÿæ”¹å˜æ—¶ï¼ŒFragment ä¼šéšç€å®¿ä¸» Activity é”€æ¯ä¸é‡å»ºï¼Œå½“æˆ‘ä»¬è°ƒç”¨ Fragment ä¸­çš„ <code>setRetainInstance(true)</code> æ–¹æ³•æ—¶ï¼Œç³»ç»Ÿå…è®¸ Fragment ç»•å¼€<code>é”€æ¯-é‡å»º</code>çš„è¿‡ç¨‹ã€‚ä½¿ç”¨è¯¥æ–¹æ³•ï¼Œå°†ä¼šå‘é€ä¿¡å·ç»™ç³»ç»Ÿï¼Œè®© Activity é‡å»ºæ—¶ï¼Œä¿ç•™ Fragment çš„å®ä¾‹ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼š</p>
<ul>
<li>ä½¿ç”¨è¯¥æ–¹æ³•åï¼Œ<strong>ä¸ä¼š</strong>è°ƒç”¨ Fragment çš„ <code>onDestory()</code> æ–¹æ³•ï¼Œä½†ä»ç„¶ä¼šè°ƒç”¨ <code>onDetach()</code> æ–¹æ³•</li>
<li>ä½¿ç”¨è¯¥æ–¹æ³•åï¼Œ<strong>ä¸ä¼š</strong>è°ƒç”¨ Fragment çš„ <code>onCreate(Bundle)</code> æ–¹æ³•ã€‚å› ä¸º Fragment æ²¡æœ‰è¢«é‡å»ºã€‚</li>
<li>ä½¿ç”¨è¯¥æ–¹æ³•åï¼ŒFragment çš„ <code>onAttach(Activity)</code> ä¸ <code>onActivityCreated(Bundle)</code> æ–¹æ³•ä»ç„¶ä¼šè¢«è°ƒç”¨ã€‚</li>
</ul>
<p>ä»¥ä¸‹ç¤ºä¾‹ä»£ç å±•ç¤ºäº†å¦‚ä½•åœ¨é…ç½®å‘ç”Ÿæ”¹å˜æ—¶ï¼Œä¿ç•™ Fragment å®ä¾‹ï¼Œå¹¶è¿›è¡Œæ•°æ®çš„æ¢å¤ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> SaveFragment mSaveFragment;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG_SAVE_FRAGMENT = <span class="string">"save_fragment"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(@Nullable Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        FragmentManager fm = getSupportFragmentManager();</span><br><span class="line">        mSaveFragment = (SaveFragment) fm.findFragmentByTag(TAG_SAVE_FRAGMENT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// fragment ä¸ä¸ºç©ºï¼Œæ˜¯å› ä¸ºé…ç½®å‘ç”Ÿæ”¹å˜ï¼ŒFragment è¢«é‡å»º</span></span><br><span class="line">        <span class="keyword">if</span> (mSaveFragment == <span class="keyword">null</span>) &#123;</span><br><span class="line">            mSaveFragment = SaveFragment.newInstance();</span><br><span class="line">            fm.beginTransaction().add(mSaveFragment, TAG_SAVE_FRAGMENT).commit();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//è·å–ä¿å­˜çš„æ•°æ®</span></span><br><span class="line">        <span class="keyword">int</span> saveData = mSaveFragment.getSaveData();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Fragment ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SaveFragment</span> <span class="keyword">extends</span> <span class="title">Fragment</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> saveData;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SaveFragment <span class="title">newInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Bundle args = <span class="keyword">new</span> Bundle();</span><br><span class="line">        SaveFragment fragment = <span class="keyword">new</span> SaveFragment();</span><br><span class="line">        fragment.setArguments(args);</span><br><span class="line">        <span class="keyword">return</span> fragment;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAttach</span><span class="params">(@NonNull Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onAttach(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(@Nullable Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        <span class="comment">//ä¿å­˜å½“å‰Fragmentå®ä¾‹</span></span><br><span class="line">        setRetainInstance(<span class="keyword">true</span>);</span><br><span class="line">        saveData = <span class="number">1010</span>;<span class="comment">//é€šè¿‡ç½‘ç»œè¯·æ±‚æˆ–æŸ¥è¯¢æ•°æ®åº“ï¼Œèµ‹å€¼éœ€è¦ä¿å­˜çš„æ•°æ®</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDetach</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onDetach();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getSaveData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> saveData;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>å…³äº Fragment çš„ setRetainInstance æ›´å¤šç”¨æ³•ä¸æ³¨æ„äº‹é¡¹ï¼Œå¯ä»¥å‚çœ‹æ–‡ç« <br><a href="https://www.androiddesignpatterns.com/2013/04/retaining-objects-across-config-changes.html" target="_blank" rel="noopener">Handling Configuration Changes with Fragments</a></p>
</blockquote>
<h4 id="ä½¿ç”¨-onRetainNonConfigurationInstance-ä¸-getLastNonConfigurationInstance"><a href="#ä½¿ç”¨-onRetainNonConfigurationInstance-ä¸-getLastNonConfigurationInstance" class="headerlink" title="ä½¿ç”¨ onRetainNonConfigurationInstance ä¸ getLastNonConfigurationInstance"></a>ä½¿ç”¨ onRetainNonConfigurationInstance ä¸ getLastNonConfigurationInstance</h4><p>åœ¨ Activity ä¸­æä¾›äº† <code>onRetainNonConfigurationInstance</code> æ–¹æ³•ï¼Œç”¨äºå¤„ç†é…ç½®å‘ç”Ÿæ”¹å˜æ—¶æ•°æ®çš„ä¿å­˜ã€‚éšååœ¨é‡æ–°åˆ›å»ºçš„ Activity ä¸­è°ƒç”¨ <code>getLastNonConfigurationInstance</code> è·å–ä¸Šæ¬¡ä¿å­˜çš„æ•°æ®ã€‚æˆ‘ä»¬ä¸èƒ½ç›´æ¥é‡å†™ä¸Šè¿°æ–¹æ³•ï¼Œå¦‚æœæƒ³åœ¨ Activity ä¸­è‡ªå®šä¹‰æƒ³è¦æ¢å¤çš„æ•°æ®ï¼Œéœ€è¦æˆ‘ä»¬è°ƒç”¨ä¸Šè¿°ä¸¤ä¸ªæ–¹æ³•çš„å†…éƒ¨æ–¹æ³•ï¼š</p>
<ul>
<li><code>onRetainCustomNonConfigurationInstance()</code></li>
<li><code>getLastCustomNonConfigurationInstance()</code></li>
</ul>
<blockquote>
<p>æ³¨æ„ï¼š<code>onRetainNonConfigurationInstance</code> æ–¹æ³•ç³»ç»Ÿè°ƒç”¨æ—¶æœºä»‹äº <code>onStop - onDestory</code> ä¹‹é—´ï¼Œ<code>getLastNonConfigurationInstance</code> æ–¹æ³•å¯åœ¨ <code>onCreate</code> ä¸ <code>onStart</code> æ–¹æ³•ä¸­è°ƒç”¨ã€‚</p>
</blockquote>
<p>ä»¥ä¸‹ä»£ç å±•ç¤ºäº†ï¼Œåœ¨ Actiity ä¸­æ¢å¤è‡ªå®šä¹‰çš„æ•°æ®ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(@Nullable Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        String name = (String) getLastCustomNonConfigurationInstance();</span><br><span class="line">        <span class="keyword">if</span> (!TextUtils.isEmpty(name)) &#123;</span><br><span class="line">            <span class="comment">//è·å–æ¢å¤åçš„æ•°æ®ï¼Œæ‰§è¡Œç›¸åº”æ“ä½œ</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä½ å¯ä»¥å¯ä»¥åœ¨onStartä¸­,è·å–æ¢å¤çš„æ•°æ®</span></span><br><span class="line"><span class="comment">//    @Override</span></span><br><span class="line"><span class="comment">//    protected void onStart() &#123;</span></span><br><span class="line"><span class="comment">//        super.onStart();</span></span><br><span class="line"><span class="comment">//        String name = (String) getLastCustomNonConfigurationInstance();</span></span><br><span class="line"><span class="comment">//        if (!TextUtils.isEmpty(name)) &#123;</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">onRetainCustomNonConfigurationInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"AndyJennifer"</span>;</span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ Android 3.0 åï¼Œå®˜æ–¹æ¨èä½¿ç”¨ <code>Fragment#setRetainInstance(true)</code> çš„æ–¹å¼è¿›è¡Œæ•°æ®çš„æ¢å¤ã€‚ä¹‹æ‰€ä»¥æ¨èè¿™ç§æ–¹å¼ï¼Œä¸ªäººçŒœæµ‹æ˜¯ä¸ºäº†é™ä½ Activity çš„å†—ä½™ï¼Œå°†æ•°æ®æ¢å¤çš„ä»»åŠ¡ä» Activity æŠ½ç¦»å‡ºæ¥ï¼Œè¿™æ›´ç¬¦åˆå•ä¸€èŒè´£çš„è®¾è®¡æ¨¡å¼ã€‚</p>
<h4 id="å‡ ç§æ•°æ®æ¢å¤æ–¹å¼çš„æ€»ç»“"><a href="#å‡ ç§æ•°æ®æ¢å¤æ–¹å¼çš„æ€»ç»“" class="headerlink" title="å‡ ç§æ•°æ®æ¢å¤æ–¹å¼çš„æ€»ç»“"></a>å‡ ç§æ•°æ®æ¢å¤æ–¹å¼çš„æ€»ç»“</h4><p>é€šè¿‡äº†è§£æ•°æ®æ¢å¤çš„å‡ ç§æ–¹å¼ï¼Œæˆ‘ä»¬èƒ½å¾—åˆ°å¦‚ä¸‹å¯¹æ¯”å›¾ï¼š</p>
<img src="/2020/03/01/ViewModelè¿™äº›çŸ¥è¯†ç‚¹ä½ éƒ½çŸ¥é“å—/æ•°æ®æ¢å¤å¯¹æ¯”.png" title="æ•°æ®æ¢å¤å¯¹æ¯”">
<h3 id="ViewModel-çš„æ¢å¤"><a href="#ViewModel-çš„æ¢å¤" class="headerlink" title="ViewModel çš„æ¢å¤"></a>ViewModel çš„æ¢å¤</h3><p>ViewModel åœ¨å®˜æ–¹è®¾è®¡ä¹‹åˆå°±å€¾å‘äºåœ¨<strong>é…ç½®æ”¹å˜</strong>æ—¶è¿›è¡Œæ•°æ®çš„æ¢å¤ã€‚è€ƒè™‘åˆ°æ•°æ®æ¢å¤æ—¶çš„æ•ˆç‡ï¼Œå®˜æ–¹æœ€ç»ˆé‡‡ç”¨äº† <code>onRetainNonConfigurationInstance</code> çš„æ–¹å¼æ¥æ¢å¤ ViewModel ã€‚</p>
<blockquote>
<p>åœ¨ SDK 27 ä¹‹å‰ï¼Œå®˜æ–¹ä¸€ç›´é‡‡ç”¨ <code>Fragment#setRetainInstance(true)</code> çš„æ–¹å¼æ¢å¤æ•°æ®ã€‚å¯¼è‡´å®˜æ–¹ä¿®æ”¹äº†å…¶å†…éƒ¨å®ç°çš„åŸå› ï¼ŒçŒœæµ‹æ˜¯å› ä¸º Fragment çš„å‘ï¼Œç¨‹åºçš„æ‰©å±•æ€§ç­‰å…¶ä»–å› ç´ ã€‚</p>
</blockquote>
<p>çŸ¥é“äº† ViewModel çš„æ¢å¤æ–¹å¼ï¼Œé‚£ç°åœ¨ä¸€èµ·æ¥è§£å†³æˆ‘ä»¬ä¹‹å‰çš„ç–‘æƒ‘ã€‚å½“ Activity å› é…ç½®å‘ç”Ÿæ”¹å˜æ—¶ï¼Œç³»ç»Ÿä¼šé‡æ–°åˆ›å»ºä¸€ä¸ªæ–°çš„ Activity ã€‚é‚£è€çš„ Activity ä¸­çš„ ViewModel æ˜¯å¦‚ä½•ä¼ é€’ç»™æ–°çš„ Activity ï¼Ÿ</p>
<p>åœ¨ Androidx ä¸­çš„ Activity çš„æœ€æ–°ä»£ç ä¸­ï¼Œå®˜æ–¹é‡å†™äº† onRetainNonConfigurationInstance æ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­ä¿å­˜äº† <code>ViewModelStore</code> (ViweModelStore ä¸­å­˜å‚¨äº† ViewModel )ï¼Œè¿›è€Œä¹Ÿä¿å­˜äº† ViewModelï¼Œå…·ä½“ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Object <span class="title">onRetainNonConfigurationInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Object custom = onRetainCustomNonConfigurationInstance();</span><br><span class="line"></span><br><span class="line">    ViewModelStore viewModelStore = mViewModelStore;</span><br><span class="line">    <span class="keyword">if</span> (viewModelStore == <span class="keyword">null</span>) &#123;</span><br><span class="line">        NonConfigurationInstances nc =</span><br><span class="line">                (NonConfigurationInstances) getLastNonConfigurationInstance();</span><br><span class="line">        <span class="keyword">if</span> (nc != <span class="keyword">null</span>) &#123;</span><br><span class="line">            viewModelStore = nc.viewModelStore;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (viewModelStore == <span class="keyword">null</span> &amp;&amp; custom == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å°†ViewModelå­˜å‚¨åœ¨ NonConfigurationInstances å¯¹è±¡ä¸­</span></span><br><span class="line">    NonConfigurationInstances nci = <span class="keyword">new</span> NonConfigurationInstances();</span><br><span class="line">    nci.custom = custom;</span><br><span class="line">    nci.viewModelStore = viewModelStore;</span><br><span class="line">    <span class="keyword">return</span> nci;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å½“æ–°çš„ Activity é‡æ–°åˆ›å»ºï¼Œå¹¶è°ƒç”¨ ViewModelProviders.of(this).get(xxxModel.class) æ—¶ï¼Œåˆä¼šåœ¨ <code>getViewModelStore()</code> æ–¹æ³•ä¸­è·å–è€ Activity ä¿å­˜çš„ ViewModelStoreã€‚é‚£ä¹ˆä¹Ÿå°±æ‹¿åˆ°äº† ViewModelã€‚å…·ä½“ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ViewModelStore <span class="title">getViewModelStore</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (getApplication() == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Your activity is not yet attached to the "</span></span><br><span class="line">                + <span class="string">"Application instance. You can't request ViewModel before onCreate call."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mViewModelStore == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//ğŸ‘‡è·å–ä¿å­˜çš„NonConfigurationInstancesï¼Œ</span></span><br><span class="line">        NonConfigurationInstances nc =</span><br><span class="line">                (NonConfigurationInstances) getLastNonConfigurationInstance();</span><br><span class="line">        <span class="keyword">if</span> (nc != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//ğŸ‘‡ä»è¯¥å¯¹è±¡ä¸­è·å–ViewModelStore</span></span><br><span class="line">            mViewModelStore = nc.viewModelStore;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mViewModelStore == <span class="keyword">null</span>) &#123;</span><br><span class="line">            mViewModelStore = <span class="keyword">new</span> ViewModelStore();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mViewModelStore;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ViewModel-ä½•æ—¶åˆ¤æ–­æ˜¯å¦è¢«ç§»é™¤"><a href="#ViewModel-ä½•æ—¶åˆ¤æ–­æ˜¯å¦è¢«ç§»é™¤" class="headerlink" title="ViewModel ä½•æ—¶åˆ¤æ–­æ˜¯å¦è¢«ç§»é™¤"></a>ViewModel ä½•æ—¶åˆ¤æ–­æ˜¯å¦è¢«ç§»é™¤</h3><p>ViewModel æœ€é‡è¦çš„ç‰¹æ€§å°±æ˜¯ä¸ä¼šåœ¨é…ç½®å‘ç”Ÿæ”¹å˜çš„æ—¶å€™è¢«ç§»é™¤ã€‚å…¶å†…éƒ¨å®ç°ä¹Ÿéå¸¸ç®€å•ï¼Œç›‘å¬ Activity å£°æ˜å‘¨æœŸï¼Œåœ¨ <code>onDestory</code> æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œåˆ¤æ–­é…ç½®æ˜¯å¦æ”¹å˜ã€‚å¦‚æœæ²¡æœ‰å‘é€æ”¹å˜ï¼Œåˆ™è°ƒç”¨ Activity ä¸­çš„ ViewModelStore çš„ <code>clear()</code> æ–¹æ³•ï¼Œæ¸…é™¤æ‰€æœ‰çš„ ViewModelã€‚å…·ä½“ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ComponentActivity</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Lifecycle lifecycle = getLifecycle();</span><br><span class="line">    <span class="comment">//çœç•¥æ›´å¤š....</span></span><br><span class="line">    getLifecycle().addObserver(<span class="keyword">new</span> LifecycleEventObserver() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStateChanged</span><span class="params">(@NonNull LifecycleOwner source,</span></span></span><br><span class="line"><span class="function"><span class="params">                @NonNull Lifecycle.Event event)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (event == Lifecycle.Event.ON_DESTROY) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!isChangingConfigurations()) &#123;</span><br><span class="line">                   <span class="comment">//ğŸ‘‡åœ¨é…ç½®æ²¡å‘ç”Ÿæ”¹å˜ä¸”èµ°åˆ°onDestoryæ–¹æ³•æ—¶ï¼Œæ¸…é™¤æ‰€æœ‰çš„ViewModel</span></span><br><span class="line">                    getViewModelStore().clear();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ViewModel-åœ¨-Fragment-çš„ç»‘å®šè¿‡ç¨‹"><a href="#ViewModel-åœ¨-Fragment-çš„ç»‘å®šè¿‡ç¨‹" class="headerlink" title="ViewModel åœ¨ Fragment çš„ç»‘å®šè¿‡ç¨‹"></a>ViewModel åœ¨ Fragment çš„ç»‘å®šè¿‡ç¨‹</h2><p>åœ¨å®˜æ–¹çš„æœ€æ–°ä»£ç å®ç°ä¸­ï¼ŒFragment ä¸­çš„ ViewModel ä¸å…¶å®¿ä¸» Activity æœ‰ç€å¯†åˆ‡çš„è”ç³»ã€‚è¦äº†è§£ ViewModel ä¸ Fragment çš„ç»‘å®šè¿‡ç¨‹ï¼Œæˆ‘ä»¬éœ€è¦å…ˆäº†è§£ <code>FragmentManager</code> ä¸ <code>FragmentManagerViewModel</code> ç›¸å…³çŸ¥è¯†ã€‚</p>
<h3 id="FragmentManager-ä»‹ç»"><a href="#FragmentManager-ä»‹ç»" class="headerlink" title="FragmentManager ä»‹ç»"></a>FragmentManager ä»‹ç»</h3><p>æ¯ä¸ª Fragment åŠå®¿ä¸» Activity (ç»§æ‰¿è‡ª <code>FragmentActivity</code>)éƒ½ä¼šåœ¨åˆ›å»ºæ—¶ï¼Œåˆå§‹åŒ–ä¸€ä¸ª FragmentManager å¯¹è±¡ï¼Œäº†è§£ Fragment ä¸­çš„ ViewModel ä¸ Activity çš„è”ç³»çš„å…³é”®ï¼Œå°±æ˜¯ç†æ¸…è¿™äº›ä¸åŒé˜¶çº§çš„æ ˆè§†å›¾ã€‚</p>
<p>ä¸‹é¢ç»™å‡ºä¸€ä¸ªç®€è¦çš„å…³ç³»å›¾ï¼š</p>
<img src="/2020/03/01/ViewModelè¿™äº›çŸ¥è¯†ç‚¹ä½ éƒ½çŸ¥é“å—/FragmentManageræ ˆå¯¹åº”å…³ç³».png" title="FragmentManageræ ˆå¯¹åº”å…³ç³»">
<ul>
<li>å¯¹äºå®¿ä¸» Activity ï¼Œ <code>getSupportFragmentManager()</code>è·å–çš„æ˜¯ FragmentActivity çš„ FragmentManager å¯¹è±¡;</li>
<li>å¯¹äº Fragment ï¼Œ <code>getFragmentManager()</code> æ˜¯è·å–çš„çˆ¶ Fragment (å¦‚æœæ²¡æœ‰ï¼Œåˆ™æ˜¯ FragmentActivity )çš„ FragmentManager å¯¹è±¡ï¼Œè€Œ <code>getChildFragmentManager()</code> æ˜¯è·å–è‡ªèº«çš„ FragmentManager å¯¹è±¡ã€‚</li>
</ul>
<h3 id="FragmentManagerViewModel-ä»‹ç»"><a href="#FragmentManagerViewModel-ä»‹ç»" class="headerlink" title="FragmentManagerViewModel ä»‹ç»"></a>FragmentManagerViewModel ä»‹ç»</h3><p>æ¯ä¸ª Fragment åˆ›å»ºæ—¶ï¼Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ª <code>FragmentManagerViewModel</code> å¯¹è±¡ï¼Œåœ¨è¯¥å¯¹è±¡ä¸­ä¸»è¦å­˜å‚¨å…¶ <code>å­Fragment</code> çš„ ViewModelStore ä¸ FragmentManagerViewMoelã€‚å…·ä½“ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<img src="/2020/03/01/ViewModelè¿™äº›çŸ¥è¯†ç‚¹ä½ éƒ½çŸ¥é“å—/FragmentManagerViewModel.png" title="FragmentManagerViewModel">
<p>åœ¨ FragmentManagerViewModel ä¸­ï¼š</p>
<ul>
<li>mViewModelStore æ˜¯ç±»å‹ä¸º <code>&lt;String, FragmentManagerViewModel&gt;</code> çš„ HashMap</li>
<li>mChildNonConfigs æ˜¯ç±»å‹ä¸º <code>&lt;String, ViewModelStore&gt;</code> çš„ HashMap</li>
</ul>
<p>ä¸Šè¿°ä¸¤ä¸ª Map å¯¹åº”çš„ Key å€¼éƒ½ä¸º Fragment çš„å”¯ä¸€ <code>UUID</code>ã€‚è¯¥ UUID ä¼šåœ¨ Fragment å¯¹è±¡åˆ›å»ºæ—¶è‡ªåŠ¨ç”Ÿæˆã€‚ä¹Ÿå°±æ˜¯æ¯ä¸ª Fragment å¯¹åº”å”¯ä¸€ UUIDã€‚</p>
<h3 id="ViewModel-åœ¨-Fragment-ç»‘å®šå…·ä½“æµç¨‹"><a href="#ViewModel-åœ¨-Fragment-ç»‘å®šå…·ä½“æµç¨‹" class="headerlink" title="ViewModel åœ¨ Fragment ç»‘å®šå…·ä½“æµç¨‹"></a>ViewModel åœ¨ Fragment ç»‘å®šå…·ä½“æµç¨‹</h3><p>ViewModel ä¸ Fragment çš„ç»‘å®šæµç¨‹æ¯”è¾ƒå¤æ‚ï¼Œä¸»è¦åˆ†ä¸ºä¸‰ä¸ªæµç¨‹ï¼š</p>
<ul>
<li>ç¬¬ä¸€æ­¥ï¼šåœ¨å®¿ä¸» Activity åˆ›å»ºæ—¶ï¼Œé»˜è®¤ä¼šåœ¨å…¶ <code>FramgentManager</code> ä¸­åˆ›å»ºä¸€ä¸ª FragmentManagerViewModelã€‚åŒæ—¶å°†ç”Ÿæˆçš„ FragmentManagerViewModel å­˜å‚¨åœ¨å…¶æœ¬èº«çš„ ViewModelStore ä¸­ã€‚åŒæ—¶ä½¿ç”¨è‡ªèº«çš„FragmentManager</li>
<li>ç¬¬äºŒæ­¥ï¼šåœ¨ Fragment åˆ›å»ºæ—¶ï¼Œä» <code>å®¿ä¸»Activity</code> æˆ– <code>çˆ¶Fragment</code> ä¸­çš„ <code>FramgentManager</code> ä¸­è·å–å¯¹åº”çš„ FragmentManagerViewModelï¼Œå¹¶ä½¿ç”¨è‡ªèº«çš„ <code>ChildFragmentManager</code> ä¸­ <code>mNonConfig</code> å˜é‡è¿›è¡Œä¿å­˜ã€‚</li>
<li>ç¬¬ä¸‰æ­¥ï¼šå°† Fragment ä¸­æ‰€åˆ›å»ºçš„ ViewModel ä¸å…¶è‡ªèº«çš„ ViewModelStore å…³è” ï¼Œå¹¶è‡ªèº«çš„ ViewModelStore å­˜å‚¨åœ¨ <code>mNonConfig</code> æ‰€æŒ‡å‘çš„ FragmentManaerViewModel ä¸­çš„ <code>mViewModelStores</code> ä¸­ã€‚</li>
</ul>
<p>ä¸‹é¢æˆ‘å°†ç»“åˆæºç å¯¹è¿™ä¸‰ä¸ªæµç¨‹è¿›è¡Œè¯¦ç»†çš„ä»‹ç»ã€‚</p>
<h4 id="ç¬¬ä¸€æ­¥æµç¨‹"><a href="#ç¬¬ä¸€æ­¥æµç¨‹" class="headerlink" title="ç¬¬ä¸€æ­¥æµç¨‹"></a>ç¬¬ä¸€æ­¥æµç¨‹</h4><blockquote>
<p>åœ¨å®¿ä¸» Activity åˆ›å»ºæ—¶ï¼Œé»˜è®¤ä¼šåœ¨å…¶ <code>FramgentManager</code> ä¸­åˆ›å»ºä¸€ä¸ª FragmentManagerViewModelã€‚åŒæ—¶å°†ç”Ÿæˆçš„ FragmentManagerViewModel å­˜å‚¨åœ¨å…¶æœ¬èº«çš„ ViewModelStore ä¸­ã€‚åŒæ—¶ä½¿ç”¨è‡ªèº«çš„FragmentManager</p>
</blockquote>
<p><code>FragmentActivity</code> ä¸­çš„ onCreate æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(@Nullable Bundle savedInstanceState)</span></span>&#123;</span><br><span class="line">    mFragments.attachHost(<span class="keyword">null</span> <span class="comment">/*parent*/</span>);<span class="comment">//ğŸ‘ˆä¼ å…¥null</span></span><br><span class="line">    <span class="comment">//çœç•¥æ›´å¤š...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>mFragments</code> æ˜¯ FragmentControllerï¼Œå†…éƒ¨é€šè¿‡ FragmentHostCallback é—´æ¥æ§åˆ¶ FragmentManagerã€‚</p>
</blockquote>
<p>è¯¥æ–¹æ³•æœ€ç»ˆä¼šæ‰§è¡Œ FragmentActivity ä¸­ FragmentManager çš„ <code>attachController</code> æ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">attachController</span><span class="params">(@NonNull FragmentHostCallback&lt;?&gt; host,</span></span></span><br><span class="line"><span class="function"><span class="params">           @NonNull FragmentContainer container, @Nullable <span class="keyword">final</span> Fragment parent)</span> </span>&#123;</span><br><span class="line">       <span class="comment">//çœç•¥æ›´å¤š...</span></span><br><span class="line">       <span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">           mNonConfig = parent.mFragmentManager.getChildNonConfig(parent);</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (host <span class="keyword">instanceof</span> ViewModelStoreOwner) &#123;</span><br><span class="line">           <span class="comment">//ğŸ‘‡èµ°è¿™é‡Œ</span></span><br><span class="line">           ViewModelStore viewModelStore = ((ViewModelStoreOwner) host).getViewModelStore();</span><br><span class="line">           mNonConfig = FragmentManagerViewModel.getInstance(viewModelStore);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           mNonConfig = <span class="keyword">new</span> FragmentManagerViewModel(<span class="keyword">false</span>);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>å› ä¸ºä¼ å…¥çš„ <code>parent = null</code>ï¼Œä¸” Activity é»˜è®¤å®ç°äº† <code>ViewModelStoreOwner</code> æ¥å£ï¼Œæ‰€ä»¥ä¼šè·å– Activity ä¸­çš„ ViewModelStoreï¼Œæ¥ç€è°ƒç”¨ FragmentManagerViewModel çš„ <code>getInstance()</code> æ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> FragmentManagerViewModel <span class="title">getInstance</span><span class="params">(ViewModelStore viewModelStore)</span> </span>&#123;</span><br><span class="line">    ViewModelProvider viewModelProvider = <span class="keyword">new</span> ViewModelProvider(viewModelStore,</span><br><span class="line">            FACTORY);</span><br><span class="line">    <span class="keyword">return</span> viewModelProvider.get(FragmentManagerViewModel.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨è¯¥æ–¹æ³•ä¸­ï¼Œä¼šåˆ›å»º FragmentManagerViewModelï¼Œå¹¶å°†å…¶æ·»åŠ åˆ° Activity ä¸­çš„ ViewModelStore ä¸­ã€‚</p>
<p>æ•´ä½“æµç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<img src="/2020/03/01/ViewModelè¿™äº›çŸ¥è¯†ç‚¹ä½ éƒ½çŸ¥é“å—/ç¬¬ä¸€æ­¥æµç¨‹.png" title="ç¬¬ä¸€æ­¥æµç¨‹">
<h4 id="ç¬¬äºŒæ­¥æµç¨‹"><a href="#ç¬¬äºŒæ­¥æµç¨‹" class="headerlink" title="ç¬¬äºŒæ­¥æµç¨‹"></a>ç¬¬äºŒæ­¥æµç¨‹</h4><blockquote>
<p>åœ¨ Fragment åˆ›å»ºæ—¶ï¼Œä» <code>å®¿ä¸»Activity</code> æˆ– <code>çˆ¶Fragment</code> ä¸­çš„ <code>FramgentManager</code> ä¸­è·å–å¯¹åº”çš„ FragmentManagerViewModelï¼Œå¹¶ä½¿ç”¨è‡ªèº«çš„ <code>ChildFragmentManager</code> ä¸­ <code>mNonConfig</code> å˜é‡è¿›è¡Œä¿å­˜ã€‚</p>
</blockquote>
<p>å½“ Fragment ä¸ Activity å…³è”æ—¶ï¼Œåœ¨å…¶ performAttach() æ–¹æ³•ä¸­</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">performAttach</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//ğŸ‘‡åˆä¼šè°ƒç”¨attachController</span></span><br><span class="line">    mChildFragmentManager.attachController(mHost, <span class="keyword">new</span> FragmentContainer() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="meta">@Nullable</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> View <span class="title">onFindViewById</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (mView == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Fragment "</span> + <span class="keyword">this</span> + <span class="string">" does not have a view"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> mView.findViewById(id);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onHasView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> (mView != <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="keyword">this</span>);<span class="comment">//ğŸ‘ˆæ³¨æ„è¿™é‡Œçš„thisä¼ å…¥çš„parentæ˜¯å½“å‰Fragment</span></span><br><span class="line">  <span class="comment">//çœç•¥æ›´å¤š...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¯¥æ–¹æ³•ä¼šè°ƒç”¨ Fragment ä¸­ <code>ChildFragmentManager</code> ä¸­çš„ attachController æ–¹æ³•å¦‚ä¸‹æ‰€ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">attachController</span><span class="params">(@NonNull FragmentHostCallback&lt;?&gt; host,</span></span></span><br><span class="line"><span class="function"><span class="params">           @NonNull FragmentContainer container, @Nullable <span class="keyword">final</span> Fragment parent)</span> </span>&#123;</span><br><span class="line">       <span class="comment">//çœç•¥æ›´å¤š...</span></span><br><span class="line">       <span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="comment">//ğŸ‘†å› ä¸ºparentä¸ºthis,æ•…æˆ‘ä»¬ä¼šè·å–Activityçš„FragmentManager</span></span><br><span class="line">           mNonConfig = parent.mFragmentManager.getChildNonConfig(parent);</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (host <span class="keyword">instanceof</span> ViewModelStoreOwner) &#123;</span><br><span class="line">           ViewModelStore viewModelStore = ((ViewModelStoreOwner) host).getViewModelStore();</span><br><span class="line">           mNonConfig = FragmentManagerViewModel.getInstance(a);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           mNonConfig = <span class="keyword">new</span> FragmentManagerViewModel(<span class="keyword">false</span>);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>æ³¨æ„ï¼Œå½“ Fragment æ˜¯ <code>å­Fragment</code> æ—¶ï¼Œparent.fragmentManager çš„å€¼ä¸ºçˆ¶Fragment çš„ FragmentManagerï¼Œå¦åˆ™ä¸º Activity ä¸­çš„ FragmentManagerã€‚</p>
</blockquote>
<p>ç»§ç»­è¿½è¸ª FragmentManager ä¸‹çš„ getChildNonConfig æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> FragmentManagerViewModel <span class="title">getChildNonConfig</span><span class="params">(Fragment f)</span></span>&#123;</span><br><span class="line">      <span class="keyword">return</span> mNonConfig.getChildNonConfig(f);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p><code>mNonConfig</code> æœ¬èº«ä¸º FragmentManagerViewModelï¼Œæˆ‘ä»¬ç»§ç»­è·Ÿè¸ªï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">FragmentManagerViewModel <span class="title">getChildNonConfig</span><span class="params">(Fragment f)</span></span>&#123;</span><br><span class="line">      FragmentManagerViewModel childNonConfig = mChildNonConfigs.get(f.mWho);</span><br><span class="line">      <span class="keyword">if</span> (childNonConfig == <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="comment">//ğŸ‘‡åˆ›å»ºFragmentçš„FragmentManagerViewModel</span></span><br><span class="line">          childNonConfig = <span class="keyword">new</span> FragmentManagerViewModel(mStateAutomaticallySaved);</span><br><span class="line">          mChildNonConfigs.put(f.mWho, childNonConfig);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> childNonConfig;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨è¯¥æ–¹æ³•ä¸­ï¼Œä¼šä» Activity ä¸­çš„ FragmentManagerViewModel ä¸­çš„ <code>mChildNonConfigs</code> ä¸­è·å– Fragment çš„ FragmentManagerViewModelï¼Œå¦‚æœæœ‰ï¼Œç›´æ¥è¿”å›ã€‚åä¹‹ï¼Œå­˜å…¥<code>mChildNonConfigs</code> ä¸­ã€‚</p>
<p>æ•´ä½“æµç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<img src="/2020/03/01/ViewModelè¿™äº›çŸ¥è¯†ç‚¹ä½ éƒ½çŸ¥é“å—/ç¬¬äºŒæ­¥æµç¨‹.png" title="ç¬¬äºŒæ­¥æµç¨‹">
<h4 id="ç¬¬ä¸‰æ­¥æµç¨‹"><a href="#ç¬¬ä¸‰æ­¥æµç¨‹" class="headerlink" title="ç¬¬ä¸‰æ­¥æµç¨‹"></a>ç¬¬ä¸‰æ­¥æµç¨‹</h4><blockquote>
<p>å°† Fragment ä¸­æ‰€åˆ›å»ºçš„ ViewModel ä¸å…¶è‡ªèº«çš„ ViewModelStore å…³è” ï¼Œå¹¶å°†è¯¥ ViewModelStore å­˜å‚¨åœ¨ <code>mNonConfig</code> æ‰€æŒ‡å‘çš„ FragmentManaerViewModel ä¸­çš„ <code>mViewModelStores</code> ä¸­ã€‚</p>
</blockquote>
<p>åœ¨ Fragment ä¸­ï¼ŒViewModelStore æ˜¯é€šè¿‡å…¶ FragmentManager åˆ›å»ºä¸è·å–çš„ã€‚å…·ä½“ä»£ç å¦‚æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ViewModelStore <span class="title">getViewModelStore</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mFragmentManager == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Can't access ViewModels from detached fragment"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mFragmentManager.getViewModelStore(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>æ³¨æ„ï¼Œå½“ Fragment æ˜¯ <code>å­Fragment</code> æ—¶ï¼Œ<code>mFragmentManager</code> çš„å€¼ä¸º çˆ¶Fragment çš„ FragmentManagerï¼Œå¦åˆ™ä¸º Activity ä¸­çš„ FragmentManagerã€‚</p>
</blockquote>
<p>ç»§ç»­è¿½è¸ª FragmentManager ä¸‹çš„ getChildNonConfig æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ViewModelStore <span class="title">getViewModelStore</span><span class="params">(@NonNull Fragment f)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> mNonConfig.getViewModelStore(f);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p><code>mNonConfig</code> æœ¬èº«ä¸º FragmentManagerViewModelï¼Œæœ€ç»ˆä¼šèµ° getViewModelStore æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ViewModelStore <span class="title">getViewModelStore</span><span class="params">(@NonNull Fragment f)</span> </span>&#123;</span><br><span class="line">      ViewModelStore viewModelStore = mViewModelStores.get(f.mWho);</span><br><span class="line">      <span class="keyword">if</span> (viewModelStore == <span class="keyword">null</span>) &#123;</span><br><span class="line">          viewModelStore = <span class="keyword">new</span> ViewModelStore();</span><br><span class="line">          <span class="comment">//å°†åˆ›å»ºå¥½çš„ViewStoreï¼Œæ”¾å…¥FragmentManagerViewModelä¸­</span></span><br><span class="line">          mViewModelStores.put(f.mWho, viewModelStore);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> viewModelStore;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨è¯¥æ–¹æ³•ä¸­æœ€ç»ˆä¼šå°† Fragment çš„ ViewModelStore å­˜å…¥ FragmentManagerViewModel ä¸­çš„ <code>mViewModelStores</code> é›†åˆä¸­ã€‚</p>
<p>é‚£ä¹ˆ Fragment çš„åˆ›å»ºå¹¶è·å– ViewModel çš„æµç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<img src="/2020/03/01/ViewModelè¿™äº›çŸ¥è¯†ç‚¹ä½ éƒ½çŸ¥é“å—/ç¬¬ä¸‰æ­¥æµç¨‹.png" title="ç¬¬ä¸‰æ­¥æµç¨‹">
<h2 id="ViewModel-åœ¨-Fragment-ä¸­ä¸ä¼šå› é…ç½®æ”¹å˜è€Œé”€æ¯çš„åŸç†"><a href="#ViewModel-åœ¨-Fragment-ä¸­ä¸ä¼šå› é…ç½®æ”¹å˜è€Œé”€æ¯çš„åŸç†" class="headerlink" title="ViewModel åœ¨ Fragment ä¸­ä¸ä¼šå› é…ç½®æ”¹å˜è€Œé”€æ¯çš„åŸç†"></a>ViewModel åœ¨ Fragment ä¸­ä¸ä¼šå› é…ç½®æ”¹å˜è€Œé”€æ¯çš„åŸç†</h2><p>ViewModel åœ¨ Fragment ä¸­ä¸ä¼šå› é…ç½®æ”¹å˜è€Œé”€æ¯çš„åŸå› å…¶å®æ˜¯å› ä¸ºå…¶å£°æ˜çš„ ViewModel æ˜¯å­˜å‚¨åœ¨ FragmentManagerViewModel ä¸­çš„ï¼Œè€Œ FragmentManagerViewModel æ˜¯å­˜å‚¨åœ¨å®¿ä¸» Activity ä¸­çš„ ViewModelStore ä¸­ï¼Œåˆå›  Activity ä¸­ ViewModelStoreä¸ä¼šå› é…ç½®æ”¹å˜è€Œé”€æ¯ï¼Œæ•… Fragment ä¸­ ViewModel ä¹Ÿä¸ä¼šå› é…ç½®æ”¹å˜è€Œé”€æ¯ã€‚</p>
<p>å½“ç„¶åœ¨ Google çš„ä»£ç å®ç°ä¸­ï¼Œä¹Ÿèƒ½å¾ˆå¥½çš„å¤„ç† Fragment åµŒå¥—çš„æƒ…å†µã€‚åœ¨ä¸‹è¿°ä¾‹å­ä¸­å±•ç¤ºäº† Fragment åµŒå¥—ä¸‹ ViewModel å­˜å‚¨çš„æƒ…å†µã€‚</p>
<img src="/2020/03/01/ViewModelè¿™äº›çŸ¥è¯†ç‚¹ä½ éƒ½çŸ¥é“å—/Activityä¸FragmentåµŒå¥—.png" title="Activityä¸FragmentåµŒå¥—">
<p>åœ¨ä¸Šå›¾ä¸­ï¼Œæˆ‘ä»¬åœ¨ Activity ä¸­ åˆ†åˆ«æ·»åŠ äº† Fragment Aã€Bã€Cã€‚å¹¶åœ¨ Fragment C ä¸­æœ‰åµŒå¥—äº† Fragment Dã€Eã€Fã€‚</p>
<p>ç»“åˆæœ¬ç¯‡æ–‡ç« æ‰€è®²è§£çš„çŸ¥è¯†ï¼Œæˆ‘ä»¬èƒ½å¾—åˆ°å¦‚ä¸‹ç»“æ„ï¼š</p>
<img src="/2020/03/01/ViewModelè¿™äº›çŸ¥è¯†ç‚¹ä½ éƒ½çŸ¥é“å—/åµŒå¥—ä¸‹å®é™…ç»“æ„.jpg" title="åµŒå¥—ä¸‹å®é™…ç»“æ„">
<p>ä»ä¸Šå›¾ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œå½“å­˜åœ¨åµŒå¥— Fragment çš„æƒ…å†µä¸‹ï¼ŒViewModel æ€»æ˜¯ä»¥<strong>çº¿æ€§</strong>çš„ç»“æ„è¿›è¡Œå­˜å‚¨ã€‚åœ¨è¿™ç§ç»“æ„ä¸‹ï¼Œå°±èƒ½è®©å®¿ä¸» Activity è‰¯å¥½çš„ç»Ÿä¸€ç®¡ç†ä¸æ‰€æœ‰çš„ ViewModelã€‚</p>
<h2 id="ViewModel-èƒ½åœ¨-Fragment-ä¸­å…±äº«çš„åŸç†"><a href="#ViewModel-èƒ½åœ¨-Fragment-ä¸­å…±äº«çš„åŸç†" class="headerlink" title="ViewModel èƒ½åœ¨ Fragment ä¸­å…±äº«çš„åŸç†"></a>ViewModel èƒ½åœ¨ Fragment ä¸­å…±äº«çš„åŸç†</h2><p>ViewModel çš„å¦ä¸€å¤§ç‰¹æ€§å°±æ˜¯èƒ½åœ¨ Fragment ä¸­å…±äº«æ•°æ®ã€‚è¿˜æ˜¯ä»¥ä¸Šå›¾ä¾‹ï¼š</p>
<p>å‡å¦‚æˆ‘ä»¬æƒ³ Fragment D è·å– Fragment A ä¸­çš„æ•°æ®ï¼Œé‚£ä¹ˆæˆ‘ä»¬åªæœ‰åœ¨ Activity ä¸­çš„ ViewModelStore ä¸‹æ·»åŠ  ViewModelã€‚åªæœ‰è¿™æ ·ï¼Œæˆ‘ä»¬æ‰èƒ½åœ¨ä¸åŒ Fragment ä¸­è·å–ç›¸åŒçš„æ•°æ®ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆåœ¨ Fragment ä¸­ä½¿ç”¨å…±äº«çš„ ViewModel æ—¶ï¼Œæˆ‘ä»¬è¦åœ¨è°ƒç”¨ViewModelProvider.of() åˆ›å»º ViewModel æ—¶éœ€è¦ä¼ å…¥ <code>getActivity()</code> çš„åŸå› ã€‚</p>
<p>å…·ä½“ä¾‹å­å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SharedViewModel</span> <span class="keyword">extends</span> <span class="title">ViewModel</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MutableLiveData&lt;Item&gt; selected = <span class="keyword">new</span> MutableLiveData&lt;Item&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">select</span><span class="params">(Item item)</span> </span>&#123;</span><br><span class="line">        selected.setValue(item);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LiveData&lt;Item&gt; <span class="title">getSelected</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> selected;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FragmentA</span> <span class="keyword">extends</span> <span class="title">Fragment</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> SharedViewModel model;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        <span class="comment">//ğŸ‘‡ä¼ å…¥çš„æ˜¯å®¿ä¸»Activity</span></span><br><span class="line">        model = ViewModelProviders.of(getActivity()).get(SharedViewModel.class);</span><br><span class="line">        itemSelector.setOnClickListener(item -&gt; &#123;</span><br><span class="line">            model.select(item);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FragmentD</span> <span class="keyword">extends</span> <span class="title">Fragment</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">         <span class="comment">//ğŸ‘‡ä¼ å…¥çš„æ˜¯å®¿ä¸»Activity</span></span><br><span class="line">        SharedViewModel model = ViewModelProviders.of(getActivity()).get(SharedViewModel.class);</span><br><span class="line">        model.getSelected().observe(<span class="keyword">this</span>, &#123; item -&gt;</span><br><span class="line">           <span class="comment">// Update the UI.</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>ç«™åœ¨å·¨äººçš„è‚©è†€ä¸Šï¼Œæ‰èƒ½çœ‹çš„æ›´è¿œ~</p>
<ul>
<li><a href="https://juejin.im/post/5a17d49b6fb9a0451704e229" target="_blank" rel="noopener">ViewModelï¼šæŒä¹…åŒ–ã€onSaveInstanceState()ã€UI çŠ¶æ€æ¢å¤å’Œ Loader</a></li>
<li><a href="https://www.jianshu.com/p/fd71d65f0ec6" target="_blank" rel="noopener">Fragmentå…¨è§£æç³»åˆ—ï¼ˆäºŒï¼‰ï¼šæ­£ç¡®çš„ä½¿ç”¨å§¿åŠ¿</a></li>
<li><a href="https://developer.android.google.cn/topic/libraries/architecture/viewmodel#sharing" target="_blank" rel="noopener">åœ¨ Fragment ä¹‹é—´å…±äº«æ•°æ®</a></li>
<li><a href="https://www.androiddesignpatterns.com/2013/04/retaining-objects-across-config-changes.html" target="_blank" rel="noopener">Handling Configuration Changes with Fragments</a></li>
</ul>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/ViewModel/" rel="tag"># ViewModel</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/01/19/Androidxä¸‹Fragmentçš„æ‡’åŠ è½½/" rel="next" title="Androidx ä¸‹ Fragment æ‡’åŠ è½½çš„æ–°å®ç°">
                <i class="fa fa-chevron-left"></i> Androidx ä¸‹ Fragment æ‡’åŠ è½½çš„æ–°å®ç°
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/04/22/ä¸ºä»€ä¹ˆJavaçš„æ³›å‹è¦ç”¨æ“¦é™¤å®ç°/" rel="prev" title="ä¸ºä»€ä¹ˆJavaçš„æ³›å‹è¦ç”¨æ“¦é™¤å®ç°">
                ä¸ºä»€ä¹ˆJavaçš„æ³›å‹è¦ç”¨æ“¦é™¤å®ç° <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            æ–‡ç« ç›®å½•
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            ç«™ç‚¹æ¦‚è§ˆ
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="http://upload-images.jianshu.io/upload_images/2824145-e320240ea6ec767d.JPG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="AndyJennifer">
            
              <p class="site-author-name" itemprop="name">AndyJennifer</p>
              <p class="site-description motion-element" itemprop="description">AndyJennifer ä¸ªäººç«™ï¼Œä¸»è¦æ¶‰åŠAndroidã€Javaã€Kotlinç­‰ç›¸å…³çŸ¥è¯†ï¼Œæ„¿ä¸å¤§å®¶å…±åŒå­¦ä¹ ï¼Œå…±åŒè¿›æ­¥</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">60</span>
                    <span class="site-state-item-name">æ—¥å¿—</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">16</span>
                    <span class="site-state-item-name">åˆ†ç±»</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">20</span>
                    <span class="site-state-item-name">æ ‡ç­¾</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/AndyJennifer" title="GitHub &rarr; https://github.com/AndyJennifer" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="/andyjennifer@126.com" title="E-Mail &rarr; andyjennifer@126.com"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#å‰è¨€"><span class="nav-number">1.</span> <span class="nav-text">å‰è¨€</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ViewModel-ä¸-Activity-çš„ç»‘å®šè¿‡ç¨‹"><span class="nav-number">2.</span> <span class="nav-text">ViewModel ä¸ Activity çš„ç»‘å®šè¿‡ç¨‹</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Factory-æ¥å£ä»‹ç»"><span class="nav-number">2.1.</span> <span class="nav-text">Factory æ¥å£ä»‹ç»</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ViewModelStore-ä»‹ç»"><span class="nav-number">2.2.</span> <span class="nav-text">ViewModelStore ä»‹ç»</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Activity-ä¸­åˆ›å»ºä¸è·å–-ViewModel-æµç¨‹"><span class="nav-number">2.3.</span> <span class="nav-text">Activity ä¸­åˆ›å»ºä¸è·å– ViewModel æµç¨‹</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ViewModel-åœ¨-Activity-ä¸­ä¸ä¼šå› é…ç½®æ”¹å˜è€Œé”€æ¯çš„åŸç†"><span class="nav-number">3.</span> <span class="nav-text">ViewModel åœ¨ Activity ä¸­ä¸ä¼šå› é…ç½®æ”¹å˜è€Œé”€æ¯çš„åŸç†</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#æ•°æ®æ¢å¤çš„å¸¸è§æ–¹å¼"><span class="nav-number">3.1.</span> <span class="nav-text">æ•°æ®æ¢å¤çš„å¸¸è§æ–¹å¼</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ä½¿ç”¨-onSaveInstanceState-ä¸-onRestoreInstanceState"><span class="nav-number">3.1.1.</span> <span class="nav-text">ä½¿ç”¨ onSaveInstanceState ä¸ onRestoreInstanceState</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ä½¿ç”¨-Fragment-çš„-setRetainInstance"><span class="nav-number">3.1.2.</span> <span class="nav-text">ä½¿ç”¨ Fragment çš„ setRetainInstance</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ä½¿ç”¨-onRetainNonConfigurationInstance-ä¸-getLastNonConfigurationInstance"><span class="nav-number">3.1.3.</span> <span class="nav-text">ä½¿ç”¨ onRetainNonConfigurationInstance ä¸ getLastNonConfigurationInstance</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#å‡ ç§æ•°æ®æ¢å¤æ–¹å¼çš„æ€»ç»“"><span class="nav-number">3.1.4.</span> <span class="nav-text">å‡ ç§æ•°æ®æ¢å¤æ–¹å¼çš„æ€»ç»“</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ViewModel-çš„æ¢å¤"><span class="nav-number">3.2.</span> <span class="nav-text">ViewModel çš„æ¢å¤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ViewModel-ä½•æ—¶åˆ¤æ–­æ˜¯å¦è¢«ç§»é™¤"><span class="nav-number">3.3.</span> <span class="nav-text">ViewModel ä½•æ—¶åˆ¤æ–­æ˜¯å¦è¢«ç§»é™¤</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ViewModel-åœ¨-Fragment-çš„ç»‘å®šè¿‡ç¨‹"><span class="nav-number">4.</span> <span class="nav-text">ViewModel åœ¨ Fragment çš„ç»‘å®šè¿‡ç¨‹</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#FragmentManager-ä»‹ç»"><span class="nav-number">4.1.</span> <span class="nav-text">FragmentManager ä»‹ç»</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#FragmentManagerViewModel-ä»‹ç»"><span class="nav-number">4.2.</span> <span class="nav-text">FragmentManagerViewModel ä»‹ç»</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ViewModel-åœ¨-Fragment-ç»‘å®šå…·ä½“æµç¨‹"><span class="nav-number">4.3.</span> <span class="nav-text">ViewModel åœ¨ Fragment ç»‘å®šå…·ä½“æµç¨‹</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ç¬¬ä¸€æ­¥æµç¨‹"><span class="nav-number">4.3.1.</span> <span class="nav-text">ç¬¬ä¸€æ­¥æµç¨‹</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ç¬¬äºŒæ­¥æµç¨‹"><span class="nav-number">4.3.2.</span> <span class="nav-text">ç¬¬äºŒæ­¥æµç¨‹</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ç¬¬ä¸‰æ­¥æµç¨‹"><span class="nav-number">4.3.3.</span> <span class="nav-text">ç¬¬ä¸‰æ­¥æµç¨‹</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ViewModel-åœ¨-Fragment-ä¸­ä¸ä¼šå› é…ç½®æ”¹å˜è€Œé”€æ¯çš„åŸç†"><span class="nav-number">5.</span> <span class="nav-text">ViewModel åœ¨ Fragment ä¸­ä¸ä¼šå› é…ç½®æ”¹å˜è€Œé”€æ¯çš„åŸç†</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ViewModel-èƒ½åœ¨-Fragment-ä¸­å…±äº«çš„åŸç†"><span class="nav-number">6.</span> <span class="nav-text">ViewModel èƒ½åœ¨ Fragment ä¸­å…±äº«çš„åŸç†</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#æœ€å"><span class="nav-number">7.</span> <span class="nav-text">æœ€å</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">AndyJennifer</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
    <span title="ç«™ç‚¹æ€»å­—æ•°">612k</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
    <span title="ç«™ç‚¹é˜…è¯»æ—¶é•¿">18:32</span>
  
</div>









        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="post-meta-item-icon">
      <i class="fa fa-user"></i>
    </span>
    <span class="site-uv" title="æ€»è®¿å®¢é‡">
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="post-meta-divider">|</span>
  

  
    <span class="post-meta-item-icon">
      <i class="fa fa-eye"></i>
    </span>
    <span class="site-pv" title="æ€»è®¿é—®é‡">
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.0"></script>

  <script src="/js/src/motion.js?v=7.0.0"></script>



  
  


  <script src="/js/src/schemes/muse.js?v=7.0.0"></script>




  
  <script src="/js/src/scrollspy.js?v=7.0.0"></script>
<script src="/js/src/post-details.js?v=7.0.0"></script>



  


  <script src="/js/src/bootstrap.js?v=7.0.0"></script>


  
  


  


  




  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
